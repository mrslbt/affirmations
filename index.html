<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Affirmations â€“ Mentra</title>
  <style>
    :root { --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); display:grid; min-height:100svh; place-items:center; }
    .wrap { width:min(720px, 92vw); }
    .card { background:var(--card); border-radius:20px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .big { font-size: clamp(24px, 5vw, 40px); line-height:1.25; text-align:center; min-height:5.5em; display:grid; place-items:center; padding:28px; transition: opacity .4s ease; text-shadow: 0 1px 2px rgba(0,0,0,.35);}
    .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    button, select { background:#1f2937; color:var(--text); border:1px solid #374151; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    details { margin-top:14px; }
    textarea { width:100%; min-height:160px; border-radius:12px; padding:12px; background:#0b1220; color:var(--text); border:1px solid #334155; }
    small { opacity:.7 }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="display" class="big">Tap Start</div>

      <div id="controls" class="row" style="margin:10px 0 16px">
        <button id="startBtn">Start</button>
        <button id="pauseBtn" disabled>Pause</button>
        <button id="prevBtn" disabled>&larr; Prev</button>
        <button id="nextBtn" disabled>Next &rarr;</button>
      </div>

      <details id="editorPanel">
        <summary><strong>Edit your 10 affirmations</strong></summary>
        <p><small>One per line. Changes autosave.</small></p>
        <textarea id="editor"></textarea>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <button id="resetBtn">Reset to sample</button>
          <small id="countNote"></small>
        </div>
      </details>
    </div>
  </div>

  <script>
    // ---- Config / defaults ----
    const DEFAULTS = [
      "I am a 5 million yen millionaire now.",
      "I am millions of yen in human form.",
      "I am the source of endless yen.",
      "I am living my 5 million yen life.",
      "I am abundance walking in Japan.",
      "I am the proof of 5 million yen freedom.",
      "I am yen wealth and power combined.",
      "I am a magnet for 5 million yen prosperity.",
      "I am 5 million yen success realized.",
      "I am the 5 million yen millionaire I choose to be."
    ];
    const qs = new URLSearchParams(location.search);
    const AUTOSTART = qs.get("autostart")==="1";
    const HIDE_UI   = qs.get("controls")==="0";
    const SHOW_MS   = Math.max(1, Number(qs.get("show")||10)) * 1000;   // visible time (default 10s)
    const WAIT_MS   = Math.max(0, Number(qs.get("wait")||30)) * 1000;   // blank time (default 30s)

    // ---- DOM helpers ----
    const $ = (id)=>document.getElementById(id);
    const display = $("display"), editor = $("editor");
    const startBtn = $("startBtn"), pauseBtn = $("pauseBtn");
    const nextBtn = $("nextBtn"), prevBtn = $("prevBtn");
    const controls = $("controls"), editorPanel = $("editorPanel");
    const resetBtn = $("resetBtn"), countNote = $("countNote");

    // ---- State ----
    let affirmations = JSON.parse(localStorage.getItem("aff_list") || "null") || DEFAULTS.slice();
    let deck = [];   // shuffled indices without repeats
    let idx = -1;    // current position in deck
    let phase = "idle"; // "show" | "blank"
    let timer = null;

    // UI setup
    if (HIDE_UI) { controls.classList.add("hidden"); editorPanel.classList.add("hidden"); }
    editor.value = affirmations.join("\n");
    updateCount();

    // ---- Core logic ----
    function shuffleDeck(){
      deck = [...affirmations.keys()];
      for (let i=deck.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      idx = -1;
    }

    function nextIndex(){
      if (deck.length === 0) shuffleDeck();
      idx++;
      if (idx >= deck.length) shuffleDeck(), idx = 0;
      return deck[idx];
    }

    function fadeTo(text){
      display.style.opacity = 0;
      setTimeout(()=>{ display.textContent = text; display.style.opacity = 1; }, 180);
    }

    function cycle(){
      clearTimeout(timer);
      if (phase === "blank"){
        // move to showing a new affirmation
        const i = nextIndex();
        fadeTo(affirmations[i] || "");
        phase = "show";
        timer = setTimeout(cycle, SHOW_MS);
      } else {
        // move to blank screen
        fadeTo(""); // completely empty during wait
        phase = "blank";
        timer = setTimeout(cycle, WAIT_MS);
      }
    }

    function start(){
      if (timer) return;
      toggle(true);
      phase = "blank"; // so first tick shows a line
      cycle();
    }

    function pause(){
      clearTimeout(timer); timer=null; phase="idle";
      toggle(false);
    }

    function prev(){
      // Step back one item in deck (stays in show phase right away)
      if (deck.length===0) return;
      idx = (idx - 2 + deck.length) % deck.length; // -2 because cycle() will ++
      phase = "blank"; cycle();
    }

    function next(){
      // Skip wait and go to next item immediately
      phase = "blank"; cycle();
    }

    function toggle(running){
      if (!HIDE_UI){
        startBtn.disabled = running;
        pauseBtn.disabled = !running;
        prevBtn.disabled = !running;
        nextBtn.disabled = !running;
      }
    }

    function saveAffs(list){
      affirmations = list.filter(Boolean);
      localStorage.setItem("aff_list", JSON.stringify(affirmations));
      updateCount();
      shuffleDeck(); // refresh deck to reflect new lines
    }

    function updateCount(){
      if (countNote) countNote.textContent = `${affirmations.length} lines saved`;
    }

    // ---- Events ----
    startBtn && (startBtn.onclick = start);
    pauseBtn && (pauseBtn.onclick = pause);
    prevBtn && (prevBtn.onclick = prev);
    nextBtn && (nextBtn.onclick = next);

    editor.addEventListener("input", ()=>{
      saveAffs(editor.value.split("\n").map(s=>s.trim()));
    });
    resetBtn.onclick = ()=>{
      editor.value = DEFAULTS.join("\n");
      saveAffs(DEFAULTS.slice());
    };

    // Best-effort keep screen awake while running
    let wakeLock=null;
    async function keepAwake(){ try { wakeLock = await navigator.wakeLock.request("screen"); } catch(e){} }
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState==="visible" && timer){ keepAwake(); }
      else if(wakeLock){ wakeLock.release().catch(()=>{}); wakeLock=null; }
    });

    // Init
    shuffleDeck();
    fadeTo("Tap Start");

    if (AUTOSTART) start();
  </script>
</body>
</html>
